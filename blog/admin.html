<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Blog CMS</title>

    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Quill Image Resize Module -->
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mirlo-orange': '#FF9E00',
                    },
                    fontFamily: {
                        'sans': ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Inter', 'sans-serif'],
                    }
                }
            },
            darkMode: 'class',
        }
    </script>

    <style>
        html {
            scroll-behavior: smooth;
        }

        .bg-grain {
            position: relative;
            background-color: #f3f4f6;
        }

        .dark .bg-grain {
            background-color: #0a0a0a;
        }

        .bg-grain::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.06;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.95' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .bg-grain>* {
            position: relative;
            z-index: 1;
        }

        .btn-plastic {
            background: linear-gradient(to bottom, #333333 0%, #000000 100%);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.8);
        }

        .btn-plastic:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .btn-plastic-orange {
            background: linear-gradient(to bottom, #ffb347 0%, #ff9e00 100%);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 4px 6px -1px rgba(255, 158, 0, 0.3);
            border: 1px solid #d18200;
        }

        .btn-plastic-orange:hover {
            transform: translateY(-1px);
            filter: brightness(1.05);
        }

        .tech-card {
            position: relative;
            background-color: #ffffff;
            border-radius: 24px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .dark .tech-card {
            background-color: #111111;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .dark .tag-chip {
            background: #374151;
        }

        .tag-chip button {
            color: #ef4444;
            font-weight: bold;
        }

        .tag-chip button:hover {
            color: #dc2626;
        }

        /* Quill Editor Styling */
        .ql-container {
            font-size: 16px;
            min-height: 300px;
        }

        .ql-editor {
            min-height: 600px;
        }

        .ql-snow .ql-editor h2 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .ql-snow .ql-editor h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
        }

        .dark .ql-toolbar {
            background: #1f2937;
            border-color: #374151 !important;
        }

        .dark .ql-container {
            background: #1f2937;
            border-color: #374151 !important;
            color: #e5e7eb;
        }

        .dark .ql-editor.ql-blank::before {
            color: #9ca3af;
        }

        .dark .ql-snow .ql-stroke {
            stroke: #e5e7eb;
        }

        .dark .ql-snow .ql-fill {
            fill: #e5e7eb;
        }

        .dark .ql-snow .ql-picker-label {
            color: #e5e7eb;
        }

        .dark .ql-snow .ql-picker-options {
            background: #1f2937;
            border-color: #374151;
        }

        /* Image resize handles */
        .ql-editor img {
            max-width: 100%;
            height: auto;
        }

        .ql-editor .ql-image-resize {
            position: relative;
        }
    </style>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>
</head>

<body class="bg-grain text-gray-900 dark:text-white font-sans antialiased min-h-screen">

    <!-- Login Screen -->
    <div id="login-screen" class="hidden fixed inset-0 bg-grain flex items-center justify-center z-50">
        <div class="tech-card p-8 md:p-12 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <i class="fas fa-lock text-5xl text-mirlo-orange mb-4"></i>
                <h1 class="text-3xl font-bold mb-2">Acceso Admin</h1>
                <p class="text-gray-600 dark:text-gray-400">Introduce tus credenciales</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold mb-2">Usuario</label>
                    <input type="text" id="login-username" required
                        class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Contraseña</label>
                    <input type="password" id="login-password" required
                        class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange">
                </div>

                <div id="login-error" class="hidden text-red-500 text-sm text-center">
                    Usuario o contraseña incorrectos
                </div>

                <button type="submit"
                    class="w-full btn-plastic-orange text-white px-6 py-3 rounded-xl font-semibold hover:scale-105 transition-transform">
                    <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión
                </button>
            </form>
        </div>
    </div>

    <!-- Main Admin Interface -->
    <div id="admin-interface" class="hidden">
        <header class="bg-white/80 dark:bg-black/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
            <nav class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <div class="text-2xl font-bold">
                    <a href="../index.html">mirlo apps<span class="text-mirlo-orange">.</span></a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="index.html"
                        class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-mirlo-orange">
                        <i class="fas fa-arrow-left mr-2"></i>Ver Blog
                    </a>
                    <button onclick="logout()" class="text-sm font-medium text-red-500 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" onclick="toggleDarkMode()" class="sr-only peer">
                        <div
                            class="relative w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-mirlo-orange">
                        </div>
                    </label>
                </div>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-12">
            <div class="mb-12">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">Blog CMS</h1>
                <p class="text-gray-600 dark:text-gray-400">Gestiona tus posts de blog de forma sencilla</p>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Editor Form -->
                <div class="tech-card p-8">
                    <h2 class="text-2xl font-bold mb-6">
                        <span id="form-title">Crear Nuevo Post</span>
                    </h2>

                    <form id="post-form" class="space-y-6">
                        <input type="hidden" id="post-id">

                        <div>
                            <label class="block text-sm font-semibold mb-2">Título *</label>
                            <input type="text" id="post-title" required
                                class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Categoría</label>
                            <select id="post-category"
                                class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange">
                                <option value="Actualizaciones">Actualizaciones</option>
                                <option value="Aplicaciones">Aplicaciones</option>
                                <option value="Personal">Personal</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Etiquetas</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="tag-input" placeholder="Añadir etiqueta..."
                                    class="flex-1 px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange">
                                <button type="button" onclick="addTag()"
                                    class="px-6 py-3 btn-plastic-orange text-white rounded-xl font-semibold">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="tags-container" class="flex flex-wrap gap-2 min-h-[2rem]">
                                <!-- Tags will appear here -->
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Extracto</label>
                            <textarea id="post-excerpt" rows="2"
                                class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange"
                                placeholder="Breve descripción del post (opcional)"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Contenido *</label>
                            <div id="editor-container"
                                class="rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700">
                                <div id="post-content-editor"></div>
                            </div>
                            <input type="hidden" id="post-content" required>
                            <p class="text-xs text-gray-500 mt-2">Usa la barra de herramientas para dar formato al texto
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Imagen</label>
                            <div class="space-y-3">
                                <!-- Upload Button -->
                                <div class="flex gap-2">
                                    <input type="file" id="image-file-input" accept="image/*" class="hidden"
                                        onchange="handleImageUpload(event)">
                                    <button type="button" onclick="document.getElementById('image-file-input').click()"
                                        class="flex-1 px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors font-medium">
                                        <i class="fas fa-upload mr-2"></i>Subir Imagen
                                    </button>
                                    <button type="button" onclick="clearImage()"
                                        class="px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-red-100 dark:hover:bg-red-900 transition-colors">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <!-- Upload Progress -->
                                <div id="upload-progress" class="hidden">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="upload-progress-bar"
                                            class="bg-mirlo-orange h-2 rounded-full transition-all" style="width: 0%">
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Subiendo imagen...</p>
                                </div>

                                <!-- Image Preview -->
                                <div id="image-preview" class="hidden space-y-2">
                                    <div class="flex justify-between items-center">
                                        <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">Imagen de
                                            Cabecera</label>
                                        <span class="text-xs text-gray-500">Se ajustará automáticamente</span>
                                    </div>
                                    <img id="preview-img" src="" alt="Preview"
                                        class="w-full max-h-48 object-cover rounded-xl border border-gray-200 dark:border-gray-700">
                                    <p class="text-xs text-gray-500">Esta imagen aparecerá en la parte superior del
                                        post. Si también aparece en el editor de texto, puedes borrarla de allí si solo
                                        la quieres de cabecera.</p>
                                </div>

                                <!-- Hidden input to store URL -->
                                <input type="hidden" id="post-image">

                                <p class="text-xs text-gray-500">Sube una imagen o déjalo vacío para usar el logo por
                                    defecto</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Fecha</label>
                            <input type="date" id="post-date" required
                                class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-mirlo-orange">
                        </div>

                        <div class="flex gap-4">
                            <button type="submit"
                                class="flex-1 btn-plastic-orange text-white px-6 py-3 rounded-xl font-semibold hover:scale-105 transition-transform">
                                <i class="fas fa-save mr-2"></i>
                                <span id="submit-text">Publicar Post</span>
                            </button>
                            <button type="button" onclick="cancelEdit()"
                                class="px-6 py-3 rounded-xl font-semibold bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Posts List -->
                <div class="tech-card p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">Posts Publicados</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="saveGitHubToken()" class="text-sm text-blue-500 hover:underline"
                                title="Configurar GitHub Token">
                                <i class="fab fa-github mr-1"></i>Config
                            </button>
                            <button onclick="migrateToGitHub()" class="text-sm text-green-500 hover:underline"
                                title="Migrar posts a GitHub">
                                <i class="fas fa-cloud-upload-alt mr-1"></i>Migrar
                            </button>
                            <button onclick="generateSitemap()" class="text-sm text-mirlo-orange hover:underline">
                                <i class="fas fa-sitemap mr-1"></i>Sitemap
                            </button>
                            <button onclick="generateRSS()" class="text-sm text-mirlo-orange hover:underline">
                                <i class="fas fa-rss mr-1"></i>RSS
                            </button>
                            <button onclick="exportPosts()" class="text-sm text-mirlo-orange hover:underline">
                                <i class="fas fa-download mr-1"></i>Exportar
                            </button>
                        </div>
                    </div>

                    <div id="posts-list" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Posts will be loaded here -->
                    </div>

                    <div id="no-posts-admin" class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>No hay posts todavía</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Authentication
        const ADMIN_USER = 'administro';
        const ADMIN_PASS = 'umaguakeño';
        let isAuthenticated = false;
        let editingPostId = null;
        let currentTags = [];

        // GitHub Configuration
        const GITHUB_REPO = 'paoloacx/mirlo-web';
        const GITHUB_FILE_PATH = 'blog-posts.json';
        let githubToken = localStorage.getItem('githubToken') || '';

        // ImgBB Configuration
        const IMGBB_API_KEY = '40df143f1b7dd7e314ceb8b86ae20372';

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            const isDark = document.documentElement.classList.contains('dark');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = isDark);
        });

        function checkAuth() {
            const sessionAuth = sessionStorage.getItem('blogAdminAuth');
            if (sessionAuth === 'true') {
                showAdminInterface();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-interface').classList.add('hidden');
        }

        function showAdminInterface() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-interface').classList.remove('hidden');
            isAuthenticated = true;
            document.getElementById('post-date').valueAsDate = new Date();
            initQuillEditor();
            loadPostsList();
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            if (username === ADMIN_USER && password === ADMIN_PASS) {
                sessionStorage.setItem('blogAdminAuth', 'true');
                showAdminInterface();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('login-error').classList.add('hidden');
                }, 3000);
            }
        });

        function logout() {
            sessionStorage.removeItem('blogAdminAuth');
            isAuthenticated = false;
            showLoginScreen();
        }

        // Image Upload Functions
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Por favor selecciona una imagen válida', 'error');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('La imagen es demasiado grande (máx 10MB)', 'error');
                return;
            }

            try {
                // Show progress
                document.getElementById('upload-progress').classList.remove('hidden');
                document.getElementById('upload-progress-bar').style.width = '30%';

                // Upload to ImgBB
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                document.getElementById('upload-progress-bar').style.width = '70%';

                if (!response.ok) {
                    throw new Error('Error al subir la imagen');
                }

                const data = await response.json();

                if (data.success) {
                    const imageUrl = data.data.url;

                    // Update hidden input
                    document.getElementById('post-image').value = imageUrl;

                    // Show preview
                    document.getElementById('preview-img').src = imageUrl;
                    document.getElementById('image-preview').classList.remove('hidden');

                    // Insert image into Quill editor at cursor position
                    const range = quill.getSelection(true);
                    quill.insertEmbed(range.index, 'image', imageUrl);
                    quill.setSelection(range.index + 1);

                    // Complete progress
                    document.getElementById('upload-progress-bar').style.width = '100%';
                    setTimeout(() => {
                        document.getElementById('upload-progress').classList.add('hidden');
                        document.getElementById('upload-progress-bar').style.width = '0%';
                    }, 500);

                    showNotification('Imagen subida e insertada en el editor. Haz click en ella para redimensionar.');
                } else {
                    throw new Error('Error en la respuesta de ImgBB');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                showNotification('Error al subir la imagen. Intenta de nuevo.', 'error');
                document.getElementById('upload-progress').classList.add('hidden');
                document.getElementById('upload-progress-bar').style.width = '0%';
            }
        }

        function clearImage() {
            document.getElementById('post-image').value = '';
            document.getElementById('image-file-input').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('preview-img').src = '';
        }

        // GitHub Integration Functions
        async function saveToGitHub(posts) {
            if (!githubToken) {
                showNotification('Configura tu GitHub token primero', 'error');
                return false;
            }

            try {
                // Get current file SHA (needed for updates)
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }

                // Prepare content
                const content = {
                    posts: posts,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                };

                const encodedContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

                // Update file
                const updateData = {
                    message: `Update blog posts - ${new Date().toISOString()}`,
                    content: encodedContent,
                    branch: 'main'
                };

                if (sha) {
                    updateData.sha = sha;
                }

                const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'Error al guardar en GitHub');
                }

                showNotification('✓ Sincronizado con GitHub');
                return true;
            } catch (error) {
                console.error('GitHub sync error:', error);
                showNotification('Error al sincronizar con GitHub: ' + error.message, 'error');
                return false;
            }
        }

        async function loadFromGitHub() {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_REPO}/main/${GITHUB_FILE_PATH}?t=${Date.now()}`);

                if (!response.ok) {
                    throw new Error('No se pudo cargar desde GitHub');
                }

                const data = await response.json();
                return data.posts || [];
            } catch (error) {
                console.error('Error loading from GitHub:', error);
                return null;
            }
        }

        async function migrateToGitHub() {
            const localPosts = JSON.parse(localStorage.getItem('blogPosts') || '[]');

            if (localPosts.length === 0) {
                showNotification('No hay posts para migrar', 'error');
                return;
            }

            if (!confirm(`¿Migrar ${localPosts.length} posts a GitHub?`)) {
                return;
            }

            const success = await saveToGitHub(localPosts);

            if (success) {
                showNotification(`${localPosts.length} posts migrados exitosamente`);
                loadPostsList();
            }
        }

        function saveGitHubToken() {
            const token = prompt('Introduce tu GitHub Personal Access Token:');
            if (token) {
                githubToken = token;
                localStorage.setItem('githubToken', token);
                showNotification('Token guardado exitosamente');
            }
        }

        // Quill Editor
        let quill;

        function initQuillEditor() {
            // Register image resize module
            Quill.register('modules/imageResize', window.ImageResize.default);

            quill = new Quill('#post-content-editor', {
                theme: 'snow',
                placeholder: 'Escribe el contenido del post aquí...',
                modules: {
                    toolbar: [
                        [{ 'header': [2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean']
                    ],
                    imageResize: {
                        displaySize: true,
                        modules: ['Resize', 'DisplaySize']
                    }
                }
            });

            // Update hidden input when content changes
            quill.on('text-change', function () {
                document.getElementById('post-content').value = quill.root.innerHTML;
            });
        }

        // Tag Management
        function addTag() {
            const input = document.getElementById('tag-input');
            const tag = input.value.trim();

            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                renderTags();
                input.value = '';
            }
        }

        function removeTag(tag) {
            currentTags = currentTags.filter(t => t !== tag);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('tags-container');
            container.innerHTML = currentTags.map(tag => `
                <span class="tag-chip">
                    ${tag}
                    <button type="button" onclick="removeTag('${tag}')" class="hover:scale-110">×</button>
                </span>
            `).join('');
        }

        // Allow Enter key to add tags
        document.getElementById('tag-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag();
            }
        });

        // Post Management
        document.getElementById('post-form').addEventListener('submit', (e) => {
            e.preventDefault();
            savePost();
        });

        async function savePost() {
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');

            // Get content from Quill editor
            const content = quill.root.innerHTML;

            const post = {
                id: editingPostId || Date.now().toString(),
                title: document.getElementById('post-title').value,
                category: document.getElementById('post-category').value,
                tags: [...currentTags],
                excerpt: document.getElementById('post-excerpt').value,
                content: content,
                image: document.getElementById('post-image').value,
                date: document.getElementById('post-date').value,
                updatedAt: new Date().toISOString()
            };

            if (editingPostId) {
                const index = posts.findIndex(p => p.id === editingPostId);
                posts[index] = post;
            } else {
                posts.unshift(post);
            }

            // Save to localStorage (always)
            localStorage.setItem('blogPosts', JSON.stringify(posts));

            // Try to sync with GitHub
            if (githubToken) {
                await saveToGitHub(posts);
            }

            // Reset form
            document.getElementById('post-form').reset();
            quill.setContents([]);
            clearImage();
            document.getElementById('post-date').valueAsDate = new Date();
            editingPostId = null;
            currentTags = [];
            renderTags();
            document.getElementById('form-title').textContent = 'Crear Nuevo Post';
            document.getElementById('submit-text').textContent = 'Publicar Post';

            loadPostsList();
            showNotification('Post guardado exitosamente!');
        }

        function loadPostsList() {
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const listContainer = document.getElementById('posts-list');
            const noPostsMsg = document.getElementById('no-posts-admin');

            if (posts.length === 0) {
                listContainer.classList.add('hidden');
                noPostsMsg.classList.remove('hidden');
                return;
            }

            listContainer.classList.remove('hidden');
            noPostsMsg.classList.add('hidden');

            listContainer.innerHTML = posts.map(post => `
                <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg mb-1 truncate">${post.title}</h3>
                            <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400 mb-2">
                                <span class="font-semibold text-mirlo-orange">${post.category}</span>
                                <span>${formatDate(post.date)}</span>
                            </div>
                            ${post.tags && post.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1">
                                    ${post.tags.map(tag => `<span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editPost('${post.id}')" 
                                class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                title="Editar">
                                <i class="fas fa-edit text-mirlo-orange"></i>
                            </button>
                            <button onclick="deletePost('${post.id}')" 
                                class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                title="Eliminar">
                                <i class="fas fa-trash text-red-500"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editPost(postId) {
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const post = posts.find(p => p.id === postId);

            if (!post) return;

            editingPostId = postId;
            document.getElementById('post-title').value = post.title;
            document.getElementById('post-category').value = post.category;
            currentTags = post.tags || [];
            renderTags();
            document.getElementById('post-excerpt').value = post.excerpt || '';

            // Set Quill content
            quill.root.innerHTML = post.content;
            document.getElementById('post-content').value = post.content;

            // Set image and show preview
            document.getElementById('post-image').value = post.image || '';
            if (post.image) {
                document.getElementById('preview-img').src = post.image;
                document.getElementById('image-preview').classList.remove('hidden');
            } else {
                document.getElementById('image-preview').classList.add('hidden');
            }

            document.getElementById('post-date').value = post.date;

            document.getElementById('form-title').textContent = 'Editar Post';
            document.getElementById('submit-text').textContent = 'Actualizar Post';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            editingPostId = null;
            currentTags = [];
            renderTags();
            document.getElementById('post-form').reset();
            quill.setContents([]);
            document.getElementById('post-date').valueAsDate = new Date();
            document.getElementById('form-title').textContent = 'Crear Nuevo Post';
            document.getElementById('submit-text').textContent = 'Publicar Post';
        }

        async function deletePost(postId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este post?')) return;

            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const filtered = posts.filter(p => p.id !== postId);
            localStorage.setItem('blogPosts', JSON.stringify(filtered));

            // Sync with GitHub
            if (githubToken) {
                await saveToGitHub(filtered);
            }

            loadPostsList();
            showNotification('Post eliminado');
        }

        function exportPosts() {
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const dataStr = JSON.stringify(posts, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `blog-posts-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Posts exportados');
        }

        function generateRSS() {
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const sortedPosts = posts.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50);

            const rssItems = sortedPosts.map(post => `
    <item>
      <title>${escapeXml(post.title)}</title>
      <link>https://mirloapps.es/blog/post.html?id=${post.id}</link>
      <description>${escapeXml(post.excerpt || post.content.substring(0, 200))}</description>
      <category>${escapeXml(post.category)}</category>
      <pubDate>${new Date(post.date).toUTCString()}</pubDate>
      <guid>https://mirloapps.es/blog/post.html?id=${post.id}</guid>
    </item>`).join('\n');

            const rss = `<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>mirlo apps Blog</title>
    <link>https://mirloapps.es/blog/</link>
    <description>Noticias, actualizaciones y artículos sobre nuestras apps</description>
    <language>es</language>
    <lastBuildDate>${new Date().toUTCString()}</lastBuildDate>
${rssItems}
  </channel>
</rss>`;

            const blob = new Blob([rss], { type: 'application/rss+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'rss.xml';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('RSS generado');
        }

        function generateSitemap() {
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const sortedPosts = posts.sort((a, b) => new Date(b.date) - new Date(a.date));

            const urlEntries = sortedPosts.map(post => `
  <url>
    <loc>https://mirloapps.es/blog/post.html?id=${post.id}</loc>
    <lastmod>${new Date(post.updatedAt || post.date).toISOString().split('T')[0]}</lastmod>
    <changefreq>monthly</changefreq>
    <priority>0.8</priority>
  </url>`).join('\n');

            const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>https://mirloapps.es/blog/</loc>
    <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>1.0</priority>
  </url>
${urlEntries}
</urlset>`;

            const blob = new Blob([sitemap], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sitemap.xml';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Sitemap generado');
        }

        function escapeXml(str) {
            return str.replace(/[<>&'"]/g, (c) => {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-mirlo-orange text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-fade-in';
            notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }
    </script>

</body>

</html>